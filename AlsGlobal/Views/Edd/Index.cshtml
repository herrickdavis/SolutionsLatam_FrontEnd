@model ResponseServiceViewModel<List<string>, List<string>, List<string>>
@inject IStringLocalizer<SharedResources> SharedLocalizer
@{
    


}

<div class="vistaLista" style="display:block">
    <div class="card card-custom gutter-b">
        <div class="card-header flex-wrap border-0 pt-6 pb-0">
            <div class="card-title">
                <h3 class="card-label" id="NombreReporte">
                    @SharedLocalizer["Reporte"]
                </h3>
            </div>
            <div>
                <button type="button" class="btn btn-primary" id="volver">Volver</button>
                <button type="button" class="btn btn-success" data-toggle="modal" data-target="#exampleModal">Guardar</button>
            </div>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-2"></div>
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-body">                            
                            <h3 class="card-title">Datos Disponibles</h3>
                            <ul id="sortable1" class="connectedSortable list-group list-unstyled multi-columns">
                                <li class="ui-state-default" id="codigo_muestra"><div class="list-group-item list-group-item-primary" role="alert">Codigo de Muestra</div></li>
                                <li class="ui-state-default" id="numero_muestra"><div class="list-group-item list-group-item-primary" role="alert">Número de Muestra</div></li>
                                <li class="ui-state-default" id="numero_proceso"><div class="list-group-item list-group-item-primary" role="alert">Número de Proceso</div></li>
                                <li class="ui-state-default" id="numero_grupo"><div class="list-group-item list-group-item-primary" role="alert">Número de Grupo</div></li>
                                
                                <li class="ui-state-default" id="nombre_estacion"><div class="list-group-item list-group-item-primary" role="alert">Estación</div></li>
                                <li class="ui-state-default" id="proyecto"><div class="list-group-item list-group-item-primary" role="alert">Proyecto</div></li>
                                <li class="ui-state-default" id="nombre_tipo_muestra"><div class="list-group-item list-group-item-primary" role="alert">Tipo Muestra</div></li>
                                <li class="ui-state-default" id="nombre_matriz"><div class="list-group-item list-group-item-primary" role="alert">Matriz</div></li>
                                <li class="ui-state-default" id="fecha_muestreo"><div class="list-group-item list-group-item-primary" role="alert">Fecha Muestreo</div></li>
                                <li class="ui-state-default" id="fecha_publicacion"><div class="list-group-item list-group-item-primary" role="alert">Fecha Publicacion</div></li>
                                <li class="ui-state-default" id="nombre_parametro"><div class="list-group-item list-group-item-primary" role="alert">Parametros</div></li>
                                <li class="ui-state-default" id="resultado"><div class="list-group-item list-group-item-primary" role="alert">Resultados</div></li>
                                <li class="ui-state-default" id="unidad"><div class="list-group-item list-group-item-primary" role="alert">Unidad</div></li>
                                <li class="ui-state-default" id="metodo"><div class="list-group-item list-group-item-primary" role="alert">Método</div></li>
                                <li class="ui-state-default" id="referencia_metodo"><div class="list-group-item list-group-item-primary" role="alert">Referencia de Método</div></li>                                
                                <li class="ui-state-default" id="nombre_limite"><div class="list-group-item list-group-item-primary" role="alert">Normativa</div></li>                                                                
                                <li class="ui-state-default" id="limite_inferior"><div class="list-group-item list-group-item-primary" role="alert">Limite Inferior</div></li>
                                <li class="ui-state-default" id="limite_superior"><div class="list-group-item list-group-item-primary" role="alert">Limite Superior</div></li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-body">
                            <h3 class="card-title">Campos Reporte</h3>
                            <ul id="sortable2" class="connectedSortable list-unstyled" style="min-height:200px">
                        
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                </div>
            </div>            
        </div>
    </div>
</div>
<div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">New message</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="recipient-name" class="col-form-label">Nombre reporte:</label>
                    <input type="text" class="form-control" id="nombre_reporte">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
                <button type="button" class="btn btn-primary" id="guardar">Guardar</button>
            </div>
        </div>
    </div>
</div>

@section scripts{
    <script>
        $(document).ready(function () {
            var urlEnviarPlanilla = "@Url.Action("EnviarPlanilla", "Edd")";
            var urlObtenerPlanilla = "@Url.Action("GetPlanilla", "Edd")";
            var itemsInSortable2

            $("#volver").on('click', function() {
                window.history.back();
            })
            $("#sortable1, #sortable2").sortable({
                connectWith: ".connectedSortable",
                stop: function (event, ui) {
                    // Si el elemento se soltó en #sortable2, registra los IDs de todos los elementos en #sortable2
                    if (ui.item.parent().attr("id") === "sortable2") {
                        itemsInSortable2 = $("#sortable2 li").map(function () {
                            return $(this).attr("id");
                        }).get();
                    }
                }
            }).disableSelection();
            let model = {};
            // Verifica si el ID está presente en la URL
            var urlParams = new URLSearchParams(window.location.search);
            var id = urlParams.get('id');

            if (id) {
                model.id = id
                var urlCompleta = urlObtenerPlanilla + "/" + id;
                $.post(urlObtenerPlanilla, model)
                    .then(response => {
                        console.log(response)
                        var ids = JSON.parse(response.configuracion);

                        ids.forEach(id => {
                            var item = $(`#sortable1 #${id}`);
                            $('#sortable2').append(item);
                        });
                        $("#NombreReporte").text("Editar Plantilla: " + response.nombre_reporte)
                        $("#nombre_reporte").val(response.nombre_reporte)
                    })
                    .catch(error => console.log(error));
            } else {
                
            }

            $("#guardar").on("click", function() {
                model.nombre_reporte = $("#nombre_reporte").val()
                itemsInSortable2 = $("#sortable2 li").map(function () {
                        return $(this).attr("id");
                    }).get();
                model.configuracion = itemsInSortable2
                if (id) {
                    model.id = id
                }
                $.post(urlEnviarPlanilla, model)
                    .then(response => {
                        $("#exampleModal").modal('hide')
                        sessionStorage.removeItem('planillas');
                        toastr.success("Se guardo la planilla correctamente");
                    })
                    .catch(error => toastr.error(error));
            })
        });
    </script>
}
